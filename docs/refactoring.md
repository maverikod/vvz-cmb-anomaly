ТЗ: Проверка и доработка пайплайна поиска и анализа CMB-анoмалий
1. Подготовка карт

Что должно работать:

    Загрузка карт температуры CMB, маски, пыли, газа (HI, CO) в формат numpy (.npy) с согласованным разрешением (nside).

    Проверка совпадения разрешения (nside) для всех карт, при необходимости понижение до минимального.

    Маска корректно применяется: все дальнейшие вычисления только по валидным пикселям.

Что проверить:

    Все карты загружены, размерность совпадает.

    После применения маски не остаётся NaN, INF, или мусорных значений в анализе.

2. Поиск аномалий (мульти-масштабный скан)

Что должно работать:

    Для каждого пикселя сетки центров на небе и каждого радиуса из заданного диапазона рассчитывается:

        Набор пикселей внутри диска заданного радиуса.

        Среднее, стандартное отклонение температуры.

        S-оценка: S = |mean_region - mean_global| / std_global.

    В итоговый первичный csv (results_anomalies_multi.csv) попадает одна запись на (центр, радиус).

Что проверить:

    S считается по глобальному σ (а не локальному!), иначе шкала сравнения теряется.

    Для каждого центра рассчитаны все радиусы, нет “провалов” или дублирующихся строк.

    В выходном csv есть: центр, (l, b), радиус, S, среднее, std, npix.

3. Отбор физических аномалий — ключевой шаг!

Что должно работать:

    Для каждого уникального центра (или с объединением близких центров):

        Находим радиус, где S максимален (по всей линии S(r)).

        В новый список вносим только этот (l, b, radius_deg, S, ...) — одна аномалия с уникальным “физическим” масштабом на каждый центр.

    Можно добавить объединение близких по координатам (l, b, radius) экстремумов в один “кластер” (например, если их центры ближе радиуса кластера друг к другу).

Что проверить:

    После агрегации на каждом (l, b) есть только одна аномалия (максимум S по r).

    Радиусы не “сеточные”, а отражают реальное распределение экстремумов.

    Итоговый массив пригоден для честного статистического анализа.

4. Гистограмма масштабов и оценка α

Что должно работать:

    По итоговой выборке построить распределение по радиусам аномалий (гистограмма).

    На логарифмической шкале (log N vs. log r) выполнить линейную регрессию, получить показатель α (наклон с минусом) и R².

    Проверить, что α осмыслен (0.7–0.8 для фазового сценария, либо другой) и нет горизонтальной линии (нет искусственного равенства числа аномалий на всех r).

Что проверить:

    Гистограмма адекватно отражает физическое распределение масштабов (есть иерархия/наклон, нет ступеней “от балды”).

    α и R² считаются по уникальным радиусам.

    Есть скрипт/функция, повторяющая fit для разных зон (галактические, |b| и пр.).

5. Контроль качества и reproducibility

Что должно работать:

    Все ключевые параметры (диапазон радиусов, шаг сетки, S-порог, объединение кластеров) задаются явно и документированы.

    Вся цепочка повторяется одной командой (или через скрипт, или makefile, или команду CLI).

    Результаты анализа (гистограммы, таблицы α/R², графики S(r), топ-N аномалий, визуализация на карте) сохраняются в отдельные папки с датой/метками параметров.

    Все промежуточные и итоговые данные доступны для независимой проверки и перекрёстного анализа.

Что проверить:

    Логика каждого шага понятна и документирована (docstring, комментарии).

    Все коды запускаются на стандартном ноутбуке (без “особого окружения”).

    При повторе с теми же параметрами даёт идентичный результат.

6. Итоговый чек-лист:

Карты загружаются, маска применяется, размерности согласованы.

S считается строго по глобальному σ, для каждого центра и радиуса.

На каждом центре аномалии выбирается только один радиус (где S максимален).

Близкие экстремумы агрегируются (по желанию — простая friends-of-friends или DBSCAN).

Итоговая гистограмма радиусов осмысленна — нет “плато” или искусственных ступеней.

α и R² считаются на этой гистограмме, результаты воспроизводимы и согласованы с физической моделью.

Весь пайплайн документирован и автоматизирован (от сырья до графиков).