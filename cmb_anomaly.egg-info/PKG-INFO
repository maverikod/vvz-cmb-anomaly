Metadata-Version: 2.4
Name: cmb-anomaly
Version: 0.1.0
Summary: Statistical analysis and anomaly detection on Planck CMB maps (SMICA 2018)
Home-page: https://github.com/yourusername/cmb-anomaly
Author: Vasily VZ
Author-email: your@email.com
License: MIT
Classifier: Programming Language :: Python :: 3
Classifier: License :: OSI Approved :: MIT License
Classifier: Operating System :: OS Independent
Classifier: Intended Audience :: Science/Research
Classifier: Topic :: Scientific/Engineering :: Astronomy
Requires-Python: >=3.8
Description-Content-Type: text/markdown
Requires-Dist: numpy>=1.20
Requires-Dist: astropy>=5.0
Dynamic: author
Dynamic: author-email
Dynamic: classifier
Dynamic: description
Dynamic: description-content-type
Dynamic: home-page
Dynamic: license
Dynamic: requires-dist
Dynamic: requires-python
Dynamic: summary

# vvz-cmb-anomaly

## Installation

```bash
pip install .
```

## Overview

This application provides a full pipeline for statistical analysis and anomaly detection on Planck CMB maps (SMICA 2018), including multiscale search, clustering, galactic correlation, and dust correlation.

## Command Line Interface (CLI)

### 1. Convert FITS to NumPy (.npy)
Convert Planck SMICA FITS files (temperature or mask) to NumPy arrays for fast analysis.

```bash
cmb-anomaly convert -i data/COM_CMB_IQU-smica_2048_R3.00_full.fits -o data/cmb_temperature.npy
cmb-anomaly convert -i data/COM_Mask_CMB-common-Mask-Int_2048_R3.00.fits -o data/mask_common.npy
```
- **Input:** FITS file
- **Output:** .npy file (NumPy array)

### 2. Multiscale Anomaly Search
Automatic search for anomalous regions at multiple radii (scales).

#### With mask (recommended for cosmological analysis):
```bash
cmb-anomaly multiscale-anomaly --temperature data/cmb_temperature.npy --mask data/mask_common.npy --results results_anomalies_multi.csv
```
- **Input:** .npy temperature, .npy mask
- **Output:** `results_anomalies_multi.csv` (all anomalies with mask)

#### Without mask (for galactic/environmental analysis):
```bash
cmb-anomaly multiscale-anomaly --temperature data/cmb_temperature.npy --no-mask --results results_anomalies_nomask.csv
```
- **Input:** .npy temperature
- **Output:** `results_anomalies_nomask.csv` (all anomalies, full sky)

### 3. Scale Clustering Analysis
Test for clustering of anomaly radii at discrete theoretical scales (no mask).

```bash
cmb-anomaly scale-clustering --csv results_anomalies_nomask.csv --alpha 0.7 --top 10
```
- **Input:** CSV with anomalies (no mask)
- **Output:** Histogram, plot (`anomaly_radius_clustering.png`), console/table output

### 4. Galactic Correlation Analysis
Analyze the correlation of anomalies with Galactic structures (disk, halo, etc).

```bash
cmb-anomaly galactic-correlation --csv results_anomalies_nomask.csv --radii 1 5 25 --out-prefix galactic_corr
```
- **Input:** CSV with anomalies (no mask)
- **Output:**
  - For each scale: CSV with all anomalies and their galactic zone (`galactic_corr_anomalies_1deg.csv`, ...)
  - Histograms by latitude/longitude, scatter plots, zone statistics (`galactic_corr_lat_hist_1deg.png`, ...)
  - Text files with zone fractions (`galactic_corr_zones_1deg.txt`, ...)

### 5. Dust Correlation Analysis
Analyze statistical correlation between CMB anomalies and a dust map (Planck, SFD, etc).

```bash
cmb-anomaly dust-correlation --anomalies galactic_corr_anomalies_1deg.csv --dust path/to/dust_map.fits --out-prefix dust_corr
```
- **Input:**
  - CSV with anomalies (with l, b, radius_deg, zone)
  - FITS file with dust map (HEALPix, full sky)
- **Output:**
  - For each scale/zone: CSV with anomalies and dust values (`dust_corr_anomalies_thin_disk_1deg.csv`, ...)
  - Histograms of dust in anomalies vs control (`dust_corr_hist_thin_disk_1deg.png`, ...)
  - Overlay map: dust + anomalies (`dust_corr_overlay_thin_disk_1deg.png`, ...)
  - Text files with statistics and p-value (`dust_corr_stats_thin_disk_1deg.txt`, ...)
  - Summary CSV with p-values for all scales/zones (`dust_corr_summary.csv`)

### 6. Region Match (Known Anomaly Search)
Find and analyze regions similar to known anomalies (from YAML) among detected anomalies.

```bash
cmb-anomaly region-match --anomalies results_anomalies_multi.csv --known-yaml data/cmb_anomalies.yaml --output matched_regions.csv --radius-tol 0.2 --top 3
```
- **Input:**
  - CSV with found anomalies (from multiscale-anomaly or galactic-correlation)
  - YAML file with known regions (must contain l, b, radius_deg, [type])
- **Output:**
  - CSV with best matches for each known region (matched_regions.csv)

## Full Analysis Workflow

1. **Convert FITS to .npy:**
   - `convert` command for temperature and mask.
2. **Run anomaly search:**
   - `multiscale-anomaly` with mask for cosmology, without mask for galactic analysis.
3. **Analyze scale clustering:**
   - `scale-clustering` on results without mask.
4. **Analyze galactic correlation:**
   - `galactic-correlation` on results without mask.
5. **Analyze dust correlation:**
   - `dust-correlation` on anomalies and dust map.
6. **Find regions similar to known anomalies:**
   - `region-match` to compare detected anomalies with known regions from YAML.

## Example Sequence

```bash
# 1. Convert data
cmb-anomaly convert -i data/COM_CMB_IQU-smica_2048_R3.00_full.fits -o data/cmb_temperature.npy
cmb-anomaly convert -i data/COM_Mask_CMB-common-Mask-Int_2048_R3.00.fits -o data/mask_common.npy

# 2. Find anomalies (with and without mask)
cmb-anomaly multiscale-anomaly --temperature data/cmb_temperature.npy --mask data/mask_common.npy --results results_anomalies_multi.csv
cmb-anomaly multiscale-anomaly --temperature data/cmb_temperature.npy --no-mask --results results_anomalies_nomask.csv

# 3. Scale clustering (no mask)
cmb-anomaly scale-clustering --csv results_anomalies_nomask.csv --alpha 0.7 --top 10

# 4. Galactic correlation (no mask)
cmb-anomaly galactic-correlation --csv results_anomalies_nomask.csv --radii 1 5 25 --out-prefix galactic_corr

# 5. Dust correlation (no mask, for each scale/zone)
cmb-anomaly dust-correlation --anomalies galactic_corr_anomalies_1deg.csv --dust path/to/dust_map.fits --out-prefix dust_corr
```

## Output Files
- `results_anomalies_multi.csv` ‚Äî anomalies with mask (cosmological)
- `results_anomalies_nomask.csv` ‚Äî anomalies without mask (full sky)
- `anomaly_radius_clustering.png` ‚Äî scale clustering plot
- `galactic_corr_anomalies_1deg.csv`, ... ‚Äî all anomalies with galactic zone for each scale
- `galactic_corr_lat_hist_1deg.png`, ... ‚Äî latitude histograms
- `galactic_corr_zones_1deg.txt`, ... ‚Äî zone statistics
- `dust_corr_anomalies_thin_disk_1deg.csv`, ... ‚Äî anomalies with dust values for each scale/zone
- `dust_corr_hist_thin_disk_1deg.png`, ... ‚Äî dust histograms
- `dust_corr_overlay_thin_disk_1deg.png`, ... ‚Äî overlay maps
- `dust_corr_stats_thin_disk_1deg.txt`, ... ‚Äî statistics and p-values
- `dust_corr_summary.csv` ‚Äî summary table for all scales/zones

## Help
- See `cmb-anomaly --help` or `cmb-anomaly --help-sequence` for all options and recommended workflow.

## –ó–∞–ø—É—Å–∫ –æ—Ç–¥–µ–ª—å–Ω—ã—Ö —à–∞–≥–æ–≤ –ø–∞–π–ø–ª–∞–π–Ω–∞

–ú–æ–∂–Ω–æ –∑–∞–ø—É—Å–∫–∞—Ç—å –∫–∞–∫ –≤–µ—Å—å –ø–∞–π–ø–ª–∞–π–Ω, —Ç–∞–∫ –∏ –æ—Ç–¥–µ–ª—å–Ω—ã–µ —à–∞–≥–∏ —Å –ø–æ–º–æ—â—å—é –∫–ª—é—á–∞ `--only`:

```
python run_pipeline.py --only <step>
```

–ì–¥–µ `<step>` ‚Äî –æ–¥–∏–Ω –∏–∑:
- convert
- multiscale
- clustering
- galactic_corr
- dust_corr
- region_match
- catalog_compare
- dust_profile

**–ü—Ä–∏–º–µ—Ä—ã:**
- –¢–æ–ª—å–∫–æ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è: `python run_pipeline.py --only convert`
- –¢–æ–ª—å–∫–æ –ø–æ–∏—Å–∫ –∞–Ω–æ–º–∞–ª–∏–π: `python run_pipeline.py --only multiscale`
- –¢–æ–ª—å–∫–æ –∫–ª–∞—Å—Ç–µ—Ä–∏–∑–∞—Ü–∏—è: `python run_pipeline.py --only clustering`
- –¢–æ–ª—å–∫–æ –º–æ—Ä—Ñ–æ–ª–æ–≥–∏—è –ø—ã–ª–∏: `python run_pipeline.py --only dust_profile`

## –ò—Å—Ö–æ–¥–Ω—ã–µ —Ñ–∞–π–ª—ã –¥–∞–Ω–Ω—ã—Ö

| –§–∞–π–ª | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ | –§–æ—Ä–º–∞—Ç | –ò—Å—Ç–æ—á–Ω–∏–∫/–æ–ø–∏—Å–∞–Ω–∏–µ |
|------|------------|--------|-------------------|
| `data/COM_CMB_IQU-smica_2048_R3.00_full.fits` | –ö–∞—Ä—Ç–∞ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã –∫–æ—Å–º–∏—á–µ—Å–∫–æ–≥–æ –º–∏–∫—Ä–æ–≤–æ–ª–Ω–æ–≤–æ–≥–æ —Ñ–æ–Ω–∞ (CMB), –∫–æ–º–ø–æ–Ω–µ–Ω—Ç SMICA, –ø–æ–ª–Ω–æ–µ –Ω–µ–±–æ, —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ NSIDE=2048. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–∞–∫ –æ—Å–Ω–æ–≤–Ω–æ–π —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–Ω—ã–π —Å–ª–æ–π –¥–ª—è –ø–æ–∏—Å–∫–∞ –∞–Ω–æ–º–∞–ª–∏–π. | FITS | [ESA Planck Legacy Archive](https://pla.esac.esa.int/#maps) (SMICA CMB map, Release 3.00) |
| `data/COM_Mask_CMB-common-Mask-Int_2048_R3.00.fits` | –ú–∞—Å–∫–∞ –¥–ª—è –≤—ã–¥–µ–ª–µ–Ω–∏—è –æ–±–ª–∞—Å—Ç–µ–π –Ω–µ–±–∞, –ø—Ä–∏–≥–æ–¥–Ω—ã—Ö –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ CMB (–∏—Å–∫–ª—é—á–∞–µ—Ç –ì–∞–ª–∞–∫—Ç–∏–∫—É –∏ —è—Ä–∫–∏–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏). –ü—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –¥–ª—è –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –∞–Ω–∞–ª–∏–∑–∞ —Ç–æ–ª—å–∫–æ –Ω–∞ —á–∏—Å—Ç—ã—Ö —É—á–∞—Å—Ç–∫–∞—Ö –Ω–µ–±–∞. | FITS | [ESA Planck Legacy Archive](https://pla.esac.esa.int/#maps) (Common CMB mask, Intensity, NSIDE=2048) |
| `data/COM_CompMap_dust-commrul_2048_R1.00.fits` | –ö–∞—Ä—Ç–∞ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –≥–∞–ª–∞–∫—Ç–∏—á–µ—Å–∫–æ–π –ø—ã–ª–∏ (dust emission), –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –∫–æ—Ä—Ä–µ–ª—è—Ü–∏–æ–Ω–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ —Å –∞–Ω–æ–º–∞–ª–∏—è–º–∏ CMB. | FITS | [ESA Planck Legacy Archive](https://pla.esac.esa.int/#maps) (Dust emission map, Release 1.00) |
| `data/NHI_HPX.fits.gz` | –ö–∞—Ä—Ç–∞ —Å—Ç–æ–ª–±–æ–≤–æ–π –ø–ª–æ—Ç–Ω–æ—Å—Ç–∏ –Ω–µ–π—Ç—Ä–∞–ª—å–Ω–æ–≥–æ –≤–æ–¥–æ—Ä–æ–¥–∞ (HI), –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ —Å–≤—è–∑–∏ –∞–Ω–æ–º–∞–ª–∏–π CMB —Å –º–µ–∂–∑–≤—ë–∑–¥–Ω–æ–π —Å—Ä–µ–¥–æ–π. | FITS (—Å–∂–∞—Ç—ã–π) | [LAB Survey of Galactic HI](https://www.astro.uni-bonn.de/hisurvey/profile/) (Leiden/Argentine/Bonn HI Survey) |

**–í—Å–µ —Ñ–∞–π–ª—ã –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —Ä–∞–∑–º–µ—â–µ–Ω—ã –≤ –∫–∞—Ç–∞–ª–æ–≥–µ `data/` –ø–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º –ø–∞–π–ø–ª–∞–π–Ω–∞.**

## üöÄ –£—Å–∫–æ—Ä–µ–Ω–∏–µ –Ω–∞ GPU (CUDA)

–î–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è –≤—ã—á–∏—Å–ª–µ–Ω–∏–π –Ω–∞ GPU –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ [CuPy](https://cupy.dev/), –ø–æ–ª–Ω–æ—Å—Ç—å—é —Å–æ–≤–º–µ—Å—Ç–∏–º–∞—è —Å NumPy.

### –ö–∞–∫ –≤–∫–ª—é—á–∏—Ç—å –ø–æ–¥–¥–µ—Ä–∂–∫—É CUDA:

1. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –ø–∞–∫–µ—Ç –¥–ª—è –≤–∞—à–µ–π –≤–µ—Ä—Å–∏–∏ CUDA (–Ω–∞–ø—Ä–∏–º–µ—Ä, –¥–ª—è CUDA 12.x):
   ```bash
   pip install cupy-cuda12x
   ```
   –ï—Å–ª–∏ —É –≤–∞—Å –¥—Ä—É–≥–∞—è –≤–µ—Ä—Å–∏—è CUDA, –≤—ã–±–µ—Ä–∏—Ç–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π –ø–∞–∫–µ—Ç: [—Å–º. –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é CuPy](https://docs.cupy.dev/en/stable/install.html#installing-cupy).

2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ CUDA –∏ GPU –≤–∏–¥–Ω—ã –∏–∑ Python:
   ```python
   import cupy
   print(cupy.cuda.runtime.getDeviceCount())
   print(cupy.cuda.runtime.getDeviceProperties(0))
   ```
   –ï—Å–ª–∏ –≤—ã–≤–æ–¥–∏—Ç—Å—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ GPU ‚Äî –≤—Å—ë —Ä–∞–±–æ—Ç–∞–µ—Ç.

3. –ü—Ä–∏ –∑–∞–ø—É—Å–∫–µ –ø–∞–π–ø–ª–∞–π–Ω–∞ –≤ –Ω–∞—á–∞–ª–µ –±—É–¥–µ—Ç –≤—ã–≤–µ–¥–µ–Ω–æ:
   - `[array_backend] CUDA detected: CuPy backend, ...` ‚Äî –µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è GPU
   - `[array_backend] CPU only: NumPy backend in use` ‚Äî –µ—Å–ª–∏ GPU –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è

4. –ï—Å–ª–∏ –≤–æ–∑–Ω–∏–∫–∞—é—Ç –æ—à–∏–±–∫–∏ ‚Äî –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ —Å—Ä–µ–¥—ã CUDA, –≤–µ—Ä—Å–∏—é –¥—Ä–∞–π–≤–µ—Ä–∞ –∏ —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å CuPy —Å –≤–∞—à–µ–π CUDA.

### –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ
- –ï—Å–ª–∏ CuPy –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∏–ª–∏ –Ω–µ –≤–∏–¥–∏—Ç GPU, –ø—Ä–æ–µ–∫—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ CPU (NumPy).
- –î–ª—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –¥—Ä–∞–π–≤–µ—Ä—ã NVIDIA –∏ CUDA Toolkit.
